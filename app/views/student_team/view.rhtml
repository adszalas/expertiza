<h1>View team for <%= @student.assignment.name %></h1>

<h2>Team members</h2>
<% if @student.team == nil%>
	You don't have a team yet!
<%else%>
	<b>Team Name: </b><%= @student.team.name %> 
	<%= link_to "Edit Name", 
					{:controller => 'student_team', :action => 'edit', :team_id => @student.team.id, :student_id => @student.id}%>
	<br><br>
	<table>
	<tr>
	<td><b>Username &nbsp</b></td>
	<td><b>Full Name &nbsp</b></td>
	<td><b>Email &nbsp</b></td>
	<td></td>
	</tr>
	<%for member in @student.team.get_participants%>
		<tr>
		<td><%= member.user.name%></td>
		<td><%= member.user.fullname%></td>
		<td><%= member.user.email%></td>
		<% if @student.assignment.teammate_review_questionnaire_id != nil and member.user.id != session[:user].id %>
		
		   <%  map = TeammateReviewMapping.find(:first, :conditions => ['reviewer_id = ? and reviewee_id = ?',@student.id, member.id])
           if map.nil? %>
   		     <td>
		     <%= link_to "Review", {:controller => 'teammate_review', :action => 'new', :reviewee_id => member.id, :id => @student.id }%>
			 </td>
			 <% else 
           review = TeammateReview.find_by_mapping_id(map.id) %>
			 <td>
			   <%= link_to "View", {:controller => 'teammate_review', :action => 'view', :id => review.id }%> 
			 </td>
			 <td>
			   <%= link_to "Edit", {:controller => 'teammate_review', :action => 'edit', :id => review.id } %>
			 </td>
		     <% end %>	                       	    
	    <% end %>
		</tr>
	<%end%>
	</table>
	<br>
	<%= link_to "Leave Team", 
					{:controller => 'student_team', :action => 'leave', :id  => @student.team.id}%>
<%end%>

<table>
<h2>Sent Invitations</h2>
<tr>
<td><b>To &nbsp</b></td>
<td><b>Reply Status &nbsp</b></td>
</tr>
<%if @send_invs.length == 0%>
	<tr>
	<td>--</td>
	<td>--</td>
	</tr>
<%else%>
	<%for inv in @send_invs%>
		<tr>
		<td><%= inv.to_user.name%></td>
		<%if inv.reply_status == 'A'%>
			<td>Accepted</td>
		<%elsif inv.reply_status == 'D'%>
				<td>Declined</td>
		<%else%>
			<td>Waiting for reply</td>
			<td><%= link_to "Retract", 
				{:controller => 'invitation', :action => 'cancel', :id => inv.id, :student_id => @student.id}%></td>
		<%end%>
		</tr>
	<%end%>
<%end%>
</table>

<table>
<h2>Received Invitations</h2>
<tr>
<td><b>From &nbsp</b></td>
<td><b>Team Name &nbsp</b></td>
<td><b>Reply &nbsp</b></td>
</tr>
<%if @received_invs.length == 0%>
	<tr>
	<td>--</td>
	<td>--</td>
	<td>--</td>
	</tr>
<%else%>
	<%for inv in @received_invs%>
	    <!--> <% if inv.reply_status == 'W'%> <-->
			<tr>
			<td><%= inv.from_user.name%></td>
			<td><%teamsusers = TeamsUser.find(:all, :conditions => ['user_id = ?', inv.from_id])%>
			    <%for teamsuser in teamsusers%>
			      <%current_team = Team.find(:first, :conditions => ['id = ? and parent_id = ?', teamsuser.team_id, @student.assignment.id])%>
			      <%if current_team != nil%>
			        <%=Team.find(current_team.id).name%>
			      <%end%>
			    <%end%></td>
			<td>
			<%= link_to "Accept", 
					{:action => 'accept', :id => inv.id, :student_id => @student.id, :team_id =>@student.team.id}%>
			|
			<%= link_to "Decline", 
						{:action => 'decline', :id => inv.id, :student_id => @student.id}%>
			</td>
			</tr>
		<!--> <%end%> <-->
	<%end%>
<%end%>
</table>

<% if @team_id == nil%>
	<h2>Create Team</h2>
	<%= form_tag :controller => 'student_team', :action => 'create'%>
	<%= hidden_field_tag 'id', @student.id %>
	<label for="team_name">Team Name:</label>&nbsp;
	<%= text_field 'team', 'name'  %>
	<%= submit_tag "Create Team" %>
	<%= end_form_tag %>
<%else%>
	<h2>Invite people</h2>
	<%= form_tag :controller => 'invitation', :action => 'create' %>
	<%= hidden_field_tag 'team_id', @team_id %>
	<%= hidden_field_tag 'student_id', @student.id %>
	<%= hidden_field_tag 'session[:dummy][:assignment_id]', @student.parent_id %>
	
	Enter user login: <%= text_field_with_auto_complete :user, :name, {:size => 41} %>
	<input type='submit' value='Invite'/>
	<%= end_form_tag %>
<%end%>

